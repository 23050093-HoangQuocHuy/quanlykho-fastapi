{% extends "base.html" %}
{% block title %}Quản lý kho{% endblock %}
{% block content %}

<div class="max-w-7xl mx-auto p-8 bg-white dark:bg-gray-800 dark:text-gray-100 shadow rounded space-y-8">

    <h2 class="text-3xl font-bold">Quản lý kho</h2>

    <!-- ================= ERROR MESSAGE ================= -->
    {% if error %}
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
        ⚠️ {{ error }}
    </div>
    {% endif %}

    <!-- ================= SEARCH SKU ================= -->
    <form method="get" action="/inventory/manage" class="flex gap-4">
        <input type="text" name="sku" value="{{ sku or '' }}"
               placeholder="Tìm theo Mã sản phẩm (VD: SKU-MOUSE-001)"
               class="flex-1 p-3 border rounded dark:bg-gray-700 dark:border-gray-600">
        <button type="submit"
                class="px-6 bg-blue-500 text-white rounded hover:bg-blue-600">
            Tìm
        </button>
    </form>

    <!-- ================= ADD ITEM ================= -->
    <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded shadow">
        <h3 class="text-xl font-semibold mb-4">Thêm sản phẩm</h3>

        <form method="post" action="/inventory/add" class="grid grid-cols-1 md:grid-cols-2 gap-4">

            <div>
                <label>Mã sản phẩm *</label>
                <input name="sku" required placeholder="SKU-MOUSE-001"
                       class="w-full p-3 border rounded">
            </div>

            <div>
                <label>Tên sản phẩm</label>
                <input name="name" required class="w-full p-3 border rounded">
            </div>

            <div>
                <label>Số lượng</label>
                <input type="number" name="quantity" required
                       class="w-full p-3 border rounded">
            </div>

            <div>
                <label>Giá</label>
                <input type="number" step="0.01" name="price" required
                       class="w-full p-3 border rounded">
            </div>

            <div>
                <label>Nhà cung cấp</label>
                <input name="supplier" class="w-full p-3 border rounded">
            </div>

            <!-- Category autocomplete -->
            <div x-data="autocomplete({{ categories|tojson }})" class="relative">
                <label>Danh mục</label>
                <input x-model="query" name="category"
                       placeholder="Nhập hoặc chọn danh mục"
                       class="w-full p-3 border rounded">

                <template x-if="filtered.length">
                    <ul class="absolute w-full bg-white border rounded mt-1 z-10">
                        <template x-for="item in filtered" :key="item.category_id">
                            <li @click="select(item)"
                                class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
                                x-text="item.name"></li>
                        </template>
                    </ul>
                </template>

                <input type="hidden" name="category_id"
                       :value="selected ? selected.category_id : ''">
            </div>

            <div class="md:col-span-2">
                <button class="w-full bg-green-500 text-white py-3 rounded hover:bg-green-600">
                    Thêm sản phẩm
                </button>
            </div>
        </form>
    </div>

    <!-- ================= LIST ITEMS ================= -->
    <div>
        <h3 class="text-xl font-semibold mb-4">Danh sách sản phẩm</h3>

        {% for item in items %}
        <div x-data="{ edit:false }" class="border p-4 rounded mb-3">

            <!-- VIEW -->
            <template x-if="!edit">
                <div class="flex justify-between">
                    <div>
                        <div class="text-sm font-mono text-gray-500">
                            Mã sản phẩm: {{ item.sku }}
                        </div>
                        <div class="font-semibold text-lg">{{ item.name }}</div>
                        <div>{{ item.quantity }} · {{ item.price }} VND</div>
                    </div>
                    <div>
                        <button @click="edit=true" class="text-blue-500 mr-4">Sửa</button>
                        <a href="/inventory/delete/{{ item.item_id }}"
                           class="text-red-500">Xóa</a>
                    </div>
                </div>
            </template>

            <!-- EDIT -->
            <template x-if="edit">
                <form method="post" action="/inventory/edit/{{ item.item_id }}"
                      class="grid grid-cols-1 md:grid-cols-2 gap-3">

                    <div>
                        <label>Mã sản phẩm</label>
                        <input value="{{ item.sku }}" disabled
                               class="w-full p-2 bg-gray-200 border rounded">
                        <input type="hidden" name="sku" value="{{ item.sku }}">
                    </div>

                    <div>
                        <label>Tên sản phẩm</label>
                        <input name="name" value="{{ item.name }}"
                               class="w-full p-2 border rounded">
                    </div>

                    <div>
                        <label>Số lượng</label>
                        <input type="number" name="quantity" value="{{ item.quantity }}"
                               class="w-full p-2 border rounded">
                    </div>

                    <div>
                        <label>Giá</label>
                        <input type="number" step="0.01" name="price" value="{{ item.price }}"
                               class="w-full p-2 border rounded">
                    </div>

                    <div>
                        <label>Nhà cung cấp</label>
                        <input name="supplier" class="w-full p-2 border rounded">
                    </div>

                    <input type="hidden" name="category_id" value="{{ item.category_id }}">

                    <div class="md:col-span-2 flex justify-end gap-2">
                        <button type="button" @click="edit=false"
                                class="px-4 py-2 bg-gray-300 rounded">
                            Hủy
                        </button>
                        <button class="px-4 py-2 bg-blue-500 text-white rounded">
                            Lưu
                        </button>
                    </div>
                </form>
            </template>

        </div>
        {% else %}
        <p>Không có sản phẩm</p>
        {% endfor %}
    </div>

</div>
{% endblock %}
